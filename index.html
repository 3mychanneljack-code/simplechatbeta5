<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simple Chat</title>

<style>
body{margin:0;font-family:sans-serif;background:#020617;color:#e5e7eb}
header{display:flex;align-items:center;padding:10px;border-bottom:1px solid #1f2937}
button,input{background:#020617;color:#e5e7eb;border:1px solid #1f2937;border-radius:6px;padding:6px}
#layout{display:grid;grid-template-columns:260px 1fr;height:calc(100vh - 50px)}
#sidebar{border-right:1px solid #1f2937;padding:10px;display:flex;flex-direction:column}
.chatItem{padding:6px;border-bottom:1px solid #1f2937;cursor:pointer}
.chatItem:hover{background:#020617}
#messages{flex:1;overflow:auto;padding:10px}
.msg.me{color:#22c55e}
.msg.them{color:#60a5fa}
</style>
</head>

<body>

<header>
<strong>Simple Chat</strong>
<span id="user" style="margin-left:auto"></span>
<button onclick="startCall()">üìû</button>
<button onclick="hangup()" id="hangBtn" style="display:none">‚ùå</button>
</header>

<div id="layout">
<div id="sidebar">
<button onclick="createChat()">‚ûï Create Chat</button>
<div id="chats"></div>
</div>

<div style="display:flex;flex-direction:column">
<div id="messages"></div>
<div style="display:flex;gap:6px;padding:10px">
<input id="msg" placeholder="Message..." style="flex:1">
<button onclick="send()">Send</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyCufn5lJsYRhTyMpOSJL3o0AjUlGFgBdI8",
 authDomain:"simple-chat-77c11.firebaseapp.com",
 projectId:"simple-chat-77c11"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let me,currentChat=null;

signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth,u=>{
 if(!u) return;
 me=u;
 user.textContent=u.displayName;
 loadChats();
});

function loadChats(){
 const q=query(collection(db,"chats"),where("members","array-contains",me.uid));
 onSnapshot(q,snap=>{
  chats.innerHTML="";
  snap.forEach(d=>{
   const div=document.createElement("div");
   div.className="chatItem";
   div.textContent=d.data().name;
   div.onclick=()=>openChat(d.id);
   chats.appendChild(div);
  });
 });
}

window.createChat=async()=>{
 const name=prompt("Chat name / username");
 if(!name) return;
 const ref=await addDoc(collection(db,"chats"),{
  name:name,
  members:[me.uid]
 });
 openChat(ref.id);
};

function openChat(id){
 currentChat=id;
 onSnapshot(collection(db,"chats",id,"messages"),snap=>{
  messages.innerHTML="";
  snap.forEach(d=>{
   const m=d.data();
   const div=document.createElement("div");
   div.className="msg "+(m.from===me.uid?"me":"them");
   div.textContent=m.text;
   messages.appendChild(div);
  });
 });
}

window.send=()=>{
 if(!currentChat||!msg.value) return;
 addDoc(collection(db,"chats",currentChat,"messages"),{
  from:me.uid,
  text:msg.value,
  ts:Date.now()
 });
 msg.value="";
};
</script>

</body>
</html>

