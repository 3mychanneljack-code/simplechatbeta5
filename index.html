<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simple Chat</title>

<link rel="manifest" href="manifest.json">

<style>
body{margin:0;font-family:sans-serif;background:#020617;color:#e5e7eb}
header{display:flex;align-items:center;padding:10px;border-bottom:1px solid #1f2937}
button,input{background:#020617;color:#e5e7eb;border:1px solid #1f2937;border-radius:6px;padding:6px}
#layout{display:grid;grid-template-columns:260px 1fr;height:calc(100vh - 50px)}
#sidebar{border-right:1px solid #1f2937;padding:10px}
#messages{flex:1;overflow:auto;padding:10px}
.msg.me{color:#22c55e}
.msg.them{color:#60a5fa}

#callPopup{
 position:fixed;inset:0;
 background:#000a;
 display:none;align-items:center;justify-content:center;
}
#callBox{
 background:#020617;padding:20px;border-radius:12px;
 text-align:center;width:260px
}
</style>
</head>

<body>

<header>
<strong>Simple Chat</strong>
<span id="user" style="margin-left:auto"></span>
<button id="callBtn" onclick="startCall()">üìû</button>
<button id="hangBtn" onclick="hangup()" style="display:none">‚ùå</button>
</header>

<div id="layout">
<div id="sidebar">Invite-only chats</div>
<div style="display:flex;flex-direction:column">
<div id="messages"></div>
<div style="display:flex;gap:6px;padding:10px">
<input id="msg" placeholder="Message..." style="flex:1">
<input type="file" id="img">
<button onclick="send()">Send</button>
</div>
</div>
</div>

<!-- Incoming call popup -->
<div id="callPopup">
<div id="callBox">
<h3>Incoming call</h3>
<button onclick="acceptCall()">Accept</button>
<button onclick="declineCall()">Decline</button>
</div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyCufn5lJsYRhTyMpOSJL3o0AjUlGFgBdI8",
 authDomain:"simple-chat-77c11.firebaseapp.com",
 projectId:"simple-chat-77c11"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let me,pc,callId;

signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth,u=>{
 if(!u) return;
 me=u;
 user.textContent=u.displayName;
 listenMessages();
 listenCalls();
});

function listenMessages(){
 onSnapshot(collection(db,"messages"),snap=>{
  messages.innerHTML="";
  snap.forEach(d=>{
   const m=d.data();
   const div=document.createElement("div");
   div.className="msg "+(m.from===me.uid?"me":"them");
   if(m.image){
    const i=document.createElement("img");
    i.src=m.image;i.style.maxWidth="200px";
    div.appendChild(i);
   } else div.textContent=m.text;
   messages.appendChild(div);
  });
 });
}

window.send=()=>{
 const f=img.files[0];
 if(f){
  const r=new FileReader();
  r.onload=()=>addDoc(collection(db,"messages"),{from:me.uid,image:r.result});
  r.readAsDataURL(f);
  img.value="";
 } else addDoc(collection(db,"messages"),{from:me.uid,text:msg.value});
 msg.value="";
};

// üìû CALLING
window.startCall=async()=>{
 callId=me.uid;
 await setDoc(doc(db,"calls",callId),{from:me.uid});
 createPeer(true);
};

function listenCalls(){
 onSnapshot(collection(db,"calls"),snap=>{
  snap.forEach(d=>{
   if(d.id!==me.uid && d.data().from!==me.uid){
    callId=d.id;
    callPopup.style.display="flex";
   }
  });
 });
}

window.acceptCall=async()=>{
 callPopup.style.display="none";
 createPeer(false);
};

window.declineCall=async()=>{
 callPopup.style.display="none";
 await deleteDoc(doc(db,"calls",callId));
};

async function createPeer(isCaller){
 pc=new RTCPeerConnection();
 const stream=await navigator.mediaDevices.getUserMedia({audio:true});
 stream.getTracks().forEach(t=>pc.addTrack(t,stream));
 pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
 callBtn.style.display="none";
 hangBtn.style.display="inline";
}

window.hangup=async()=>{
 if(pc) pc.close();
 await deleteDoc(doc(db,"calls",callId));
 callBtn.style.display="inline";
 hangBtn.style.display="none";
};
</script>

</body>
</html>
